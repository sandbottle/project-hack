!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jspython={})}(this,(function(e){"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function o(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function s(e,t){for(var n=0,r=t.length,o=e.length;n<r;n++,o++)e[o]=t[n];return e}function a(e){return e.startsWith("/")||e.startsWith("./")?e.endsWith(".json")?"json":"jspyModule":"jsPackage"}function l(e,t,n,r,o){return e+": "+t+"("+n+","+r+"): "+o}!function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=l("JspyTokenizerError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}n(t,e)}(Error);var c,u=function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=l("JspyParserError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}return n(t,e),t}(Error),h=function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=l("JspyEvalError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}return n(t,e),t}(Error),f=function(e){function t(n,r,o,i,s){var a=e.call(this)||this;return a.module=n,a.line=r,a.column=o,a.name=i,a.message=s,a.message=l("JspyError",n||"name.jspy",r,o,s),Object.setPrototypeOf(a,t.prototype),a}return n(t,e),t}(Error);!function(e){e[e.Arithmetic=0]="Arithmetic",e[e.Assignment=1]="Assignment",e[e.Comparison=2]="Comparison",e[e.Logical=3]="Logical",e[e.Membership=4]="Membership"}(c||(c={}));var p,d={"+":c.Arithmetic,"-":c.Arithmetic,"*":c.Arithmetic,"/":c.Arithmetic,"%":c.Arithmetic,"**":c.Arithmetic,"//":c.Arithmetic,">":c.Comparison,">=":c.Comparison,"==":c.Comparison,"!=":c.Comparison,"<>":c.Comparison,"<":c.Comparison,"<=":c.Comparison,and:c.Logical,or:c.Logical,in:c.Membership,"=":c.Assignment,"+=":c.Assignment,"-=":c.Assignment,"*=":c.Assignment,"/=":c.Assignment,"++":c.Assignment,"--":c.Assignment},y={"+":function(e,t){return g(e,t,"+")},"-":function(e,t){return g(e,t,"-")},"/":function(e,t){return g(e,t,"/")},"*":function(e,t){return g(e,t,"*")},"%":function(e,t){return g(e,t,"%")},"**":function(e,t){return g(e,t,"**")},"//":function(e,t){return g(e,t,"//")},">":function(e,t){return m(e,t,">")},">=":function(e,t){return m(e,t,">=")},"<":function(e,t){return m(e,t,"<")},"<=":function(e,t){return m(e,t,"<=")},"==":function(e,t){return m(e,t,"==")},"!=":function(e,t){return m(e,t,"!=")},"<>":function(e,t){return m(e,t,"<>")},and:function(e,t){return v(e,t,"and")},or:function(e,t){return v(e,t,"or")},in:function(e,t){return function(e,t,n){if("string"==typeof e)return e.includes(String(t));if(Array.isArray(e))return e.includes(t);throw new Error("Unknown operation '"+n+"'")}(e,t,"in")}};function v(e,t,n){switch(n){case"and":return e&&t;case"or":return e||t}throw new Error("Unknown operation '"+n+"'")}function m(e,t,n){switch(n){case"==":return e===t;case"!=":case"<>":return e!==t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}throw new Error("Unknown operation '"+n+"'")}function g(e,t,n){switch(n){case"+":return e+t;case"-":return e-t;case"*":return e*t;case"/":return e/t;case"%":return e%t;case"**":return Math.pow(e,t)}throw new Error("Unknown operation '"+n+"'")}function k(e){return e[1][0]}function b(e){return e?e[0]:null}function w(e){return e[1].subarray(1)}function N(e){return e[1][1]}function C(e){return e[1][2]}function x(e,t){var n=[];if(!e.length)return[];for(var r=E(e,(function(e){return e===t})),o=0,i=0;i<r.length;i++){var s=r[i];n.push(e.slice(o,s)),o=s+1}return n.push(e.slice(o,e.length)),n}function A(e,t,n){void 0===n&&(n=0);for(var r=n;r<e.length;r++)if(k(e[r])!==p.LiteralString)if("("===b(e[r]))r=O(e,r,"(",")");else if("["===b(e[r]))r=O(e,r,"[","]");else if("{"===b(e[r]))r=O(e,r,"{","}");else if(t(b(e[r])))return r;return-1}function E(e,t){for(var n=[],r=0;r<e.length;r++){var o=b(e[r]);k(e[r])!==p.LiteralString&&("("===o?r=O(e,r,"(",")"):"["===o?r=O(e,r,"[","]"):"{"===o?r=O(e,r,"{","}"):t(o)&&n.push(r))}return n}function S(e,t){return void 0===t&&(t=null),E(e,t?function(e){return d[e]===t}:function(e){return void 0!==d[e]})}function O(e,t,n,r){for(var o=0;b(e[++t])!==r||0!==o;){if(t+1>=e.length)throw new Error("Closing '"+r+"' is missing");var i=b(e[t]);i===n&&o++,i===r&&o--}return t}!function(e){e[e.Identifier=0]="Identifier",e[e.Keyword=1]="Keyword",e[e.Separator=2]="Separator",e[e.Operator=3]="Operator",e[e.LiteralNumber=4]="LiteralNumber",e[e.LiteralBool=5]="LiteralBool",e[e.LiteralString=6]="LiteralString",e[e.LiteralNull=7]="LiteralNull",e[e.Comment=8]="Comment"}(p||(p={}));var j=function(e){this.type=e,this.loc=void 0},_=function(e){function t(t,n,r){var o=e.call(this,"assign")||this;return o.target=t,o.source=n,o.loc=r,o.loc=r,o}return n(t,e),t}(j),L=function(e){function t(t){var n=e.call(this,"const")||this;return n.value=b(t),n.loc=w(t),n}return n(t,e),t}(j),B=function(e){function t(t,n){var r=e.call(this,"comment")||this;return r.comment=t,r.loc=n,r.loc=n,r}return n(t,e),t}(j),T=function(e){function t(t,n){void 0===t&&(t=void 0);var r=e.call(this,"return")||this;return r.returnValue=t,r.loc=n,r.loc=n,r}return n(t,e),t}(j),P=function(e){function t(t,n,r){var o=e.call(this,"raise")||this;return o.errorName=t,o.errorMessage=n,o.loc=r,o.loc=r,o}return n(t,e),t}(j),F=function(e){function t(){return e.call(this,"continue")||this}return n(t,e),t}(j),I=function(e){function t(){return e.call(this,"break")||this}return n(t,e),t}(j);!function(e){function t(t){var n=e.call(this,"setSingleVar")||this;return n.name=t[0],n.loc=w(t),n}n(t,e)}(j);var W=function(e){function t(t,n,r){var o=e.call(this,"funcCall")||this;return o.name=t,o.paramNodes=n,o.loc=r,o.nullCoelsing=void 0,o.loc=r,o}return n(t,e),t}(j),M=function(e){function t(t,n,r,o){var i=e.call(this,"funcDef")||this;return i.funcAst=t,i.params=n,i.isAsync=r,i.loc=o,i.loc=o,i}return n(t,e),t}(j),V=function(e){function t(t,n,r){var o=e.call(this,"arrowFuncDef")||this;return o.funcAst=t,o.params=n,o.loc=r,o.loc=r,o}return n(t,e),t}(j),J=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"if")||this;return i.conditionNode=t,i.ifBody=n,i.elseBody=r,i.loc=o,i.loc=o,i}return n(t,e),t}(j),U=function(e){function t(t,n,r,o,i){var s=e.call(this,"tryExcept")||this;return s.tryBody=t,s.exepts=n,s.elseBody=r,s.finallyBody=o,s.loc=i,s.loc=i,s}return n(t,e),t}(j),D=function(e){function t(t,n,r,o){var i=e.call(this,"for")||this;return i.sourceArray=t,i.itemVarName=n,i.body=r,i.loc=o,i.loc=o,i}return n(t,e),t}(j),z=function(e){function t(t,n,r){var o=e.call(this,"while")||this;return o.condition=t,o.body=n,o.loc=r,o.loc=r,o}return n(t,e),t}(j),K=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"import")||this;return i.module=t,i.body=n,i.parts=r,i.loc=o,i.loc=o,i}return n(t,e),t}(j),R=function(e){function t(t,n){void 0===n&&(n=void 0);var r=e.call(this,"getSingleVar")||this;return r.nullCoelsing=void 0,r.name=t[0],r.nullCoelsing=n,r.loc=w(t),r}return n(t,e),t}(j),G=function(e){function t(t,n){var r=e.call(this,"dotObjectAccess")||this;return r.nestedProps=t,r.loc=n,r.loc=n,r}return n(t,e),t}(j),q=function(e){function t(t,n){var r=e.call(this,"createObject")||this;return r.props=t,r.loc=n,r.loc=n,r}return n(t,e),t}(j),H=function(e){function t(t,n){var r=e.call(this,"createArray")||this;return r.items=t,r.loc=n,r.loc=n,r}return n(t,e),t}(j),Q=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"bracketObjectAccess")||this;return i.propertyName=t,i.bracketBody=n,i.nullCoalescing=r,i.loc=o,i.loc=o,i}return n(t,e),t}(j),X=function(e){function t(t,n){var r=e.call(this,"logicalOp")||this;return r.items=t,r.loc=n,r.loc=n,r}return n(t,e),t}(j),Y=function(e){function t(t,n,r,o){var i=e.call(this,"binOp")||this;return i.left=t,i.op=n,i.right=r,i.loc=o,i.loc=o,i}return n(t,e),t}(j);function Z(e){return{moduleName:e.moduleName,blockScope:e.blockScope.clone()}}var $=function(){function e(e){this.scope={},this.scope=r({},e)}return e.prototype.getScope=function(){return this.scope},e.prototype.clone=function(){return new e(this.scope)},e.prototype.set=function(e,t,n){this.scope[e]=t},e.prototype.get=function(e,t){return this.scope[e]},e}(),ee=function(){function e(){}return e.prototype.evalBlock=function(e,t){for(var n=this,r=null,o=function(e){var r=e;t.blockScope.set(r.funcAst.name,(function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];return n.jspyFuncInvoker.apply(n,s([r,t],e))}))},i=0,a=(null==e?void 0:e.funcs)||[];i<a.length;i++){o(u=a[i])}for(var l=0,c=e.body;l<c.length;l++){var u;if("comment"!==(u=c[l]).type){if("import"===u.type)throw new Error("Import is not support with 'eval'. Use method 'evalAsync' instead");try{if(r=this.evalNode(u,t),t.returnCalled){var p=t.returnObject;return"func"!=e.type&&"module"!=e.type||(t.returnCalled=!1,t.returnObject=null),p}if(t.continueCalled)break;if(t.breakCalled)break}catch(e){var d=u.loc?u.loc:[0,0];throw e instanceof f||e instanceof h?e:new h(t.moduleName,d[0],d[1],e.message||e)}}}return r},e.prototype.jspyFuncInvoker=function(e,t){for(var n,r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var i=Object.assign({},e.funcAst);i.type="func";for(var s=Z(t),a=0;a<(null===(n=e.params)||void 0===n?void 0:n.length);a++){var l=(null==r?void 0:r.length)>a?r[a]:null;s.blockScope.set(e.params[a],l)}return this.evalBlock(i,s)},e.prototype.invokeFunction=function(e,t,n){if(0===t.length)return e();if(1===t.length)return e(t[0]);if(2===t.length)return e(t[0],t[1]);if(3===t.length)return e(t[0],t[1],t[2]);if(4===t.length)return e(t[0],t[1],t[2],t[3]);if(5===t.length)return e(t[0],t[1],t[2],t[3],t[4]);if(6===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5]);if(7===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6]);if(8===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]);if(9===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);if(10===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9]);if(11===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10]);if(12===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]);if(13===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]);if(14===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13]);if(15===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14]);throw Error("Function has too many parameters. Current limitation is 15")},e.prototype.evalNode=function(e,t){var n,r,o,i,a,l,c,u=this;if("import"===e.type)return null;if("comment"===e.type)return null;if("if"!==e.type){if("raise"===e.type){var h,p=e;throw new f(t.moduleName,p.loc[0],p.loc[1],p.errorName,p.errorMessage||"")}if("tryExcept"!==e.type){if("return"===e.type){var d=e;return t.returnCalled=!0,t.returnObject=d.returnValue?this.evalNode(d.returnValue,t):null,t.returnObject}if("continue"!==e.type)if("break"!==e.type)if("for"!==e.type)if("while"!==e.type){if("const"===e.type)return e.value;if("getSingleVar"===e.type){var v=e.name,m=t.blockScope.get(e.name);if(void 0===m)throw";"===v.charAt(v.length-1)?new Error("Unexpected ';' in the end."):new Error("Variable '"+v+"' is not defined.");return m}if("binOp"===e.type){var g=e,k=this.evalNode(g.left,t),b=this.evalNode(g.right,t);return y[g.op](k,b)}if("logicalOp"===e.type){for(var w=e,N=0,C=!0;N<w.items.length;){var x=w.items[N++];if(C=this.evalNode(x.node,t),"and"===x.op&&!C)return!1;if("or"===x.op&&C)return C}return C}if("arrowFuncDef"===e.type){var A=e;return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return u.jspyFuncInvoker.apply(u,s([A,t],e))}}if("funcCall"===e.type){var E=e;if("function"!=typeof(V=t.blockScope.get(E.name)))throw Error("'"+E.name+"' is not a function or not defined.");var S=(null===(l=E.paramNodes)||void 0===l?void 0:l.map((function(e){return u.evalNode(e,t)})))||[];return this.invokeFunction(V,S,{moduleName:t.moduleName,line:E.loc[0],column:E.loc[1]})}if("assign"===e.type){var O=e;if("getSingleVar"===O.target.type){var j=O.target;t.blockScope.set(j.name,this.evalNode(O.source,t))}else if("dotObjectAccess"===O.target.type){var _=O.target,L=new G(_.nestedProps.slice(0,_.nestedProps.length-1),_.loc);this.evalNode(L,t)[_.nestedProps[_.nestedProps.length-1].name]=this.evalNode(O.source,t)}else{if("bracketObjectAccess"!==O.target.type)throw Error("Not implemented Assign operation");_=O.target;var B=this.evalNode(_.bracketBody,t);t.blockScope.get(_.propertyName)[B]=this.evalNode(O.source,t)}return null}if("bracketObjectAccess"===e.type){var T=e,P=this.evalNode(T.bracketBody,t);return void 0===(J=t.blockScope.get(T.propertyName))[P]?null:J[P]}if("dotObjectAccess"===e.type){var F=e,I=this.evalNode(F.nestedProps[0],t);for(Y=1;Y<F.nestedProps.length;Y++){var W=F.nestedProps[Y];if(F.nestedProps[Y-1].nullCoelsing&&!I&&(I={}),"getSingleVar"===W.type)I=I[W.name];else if("bracketObjectAccess"===W.type){var M=W;I=(I=I[M.propertyName])[this.evalNode(M.bracketBody,t)]}else{if("funcCall"!==W.type)throw Error("Can't resolve dotObjectAccess node");var V;if(null==(V=I[(E=W).name])&&F.nestedProps[Y-1].nullCoelsing){I=null;continue}if("function"!=typeof V)throw Error("'"+E.name+"' is not a function or not defined.");S=(null===(c=E.paramNodes)||void 0===c?void 0:c.map((function(e){return u.evalNode(e,t)})))||[];I=this.invokeFunction(V.bind(I),S,{moduleName:t.moduleName,line:E.loc[0],column:E.loc[1]})}}return void 0===I?null:I}if("createObject"===e.type){for(var J={},U=0,D=e.props;U<D.length;U++){var z=D[U];J[this.evalNode(z.name,t)]=this.evalNode(z.value,t)}return J}if("createArray"===e.type){for(var K=[],R=0,q=e.items;R<q.length;R++){Z=q[R];K.push(this.evalNode(Z,t))}return K}}else{for(var H=e;this.evalNode(H.condition,t)&&(this.evalBlock({name:t.moduleName,type:"while",body:H.body},t),t.continueCalled&&(t.continueCalled=!1),!t.breakCalled););t.breakCalled&&(t.breakCalled=!1)}else{for(var Q=e,X=this.evalNode(Q.sourceArray,t),Y=0;Y<X.length;Y++){var Z=X[Y];if(t.blockScope.set(Q.itemVarName,Z),this.evalBlock({name:t.moduleName,type:"for",body:Q.body},t),t.continueCalled&&(t.continueCalled=!1),t.breakCalled)break}t.breakCalled&&(t.breakCalled=!1)}else t.breakCalled=!0;else t.continueCalled=!0}else{var $=e;try{this.evalBlock({name:t.moduleName,type:"trycatch",body:$.tryBody},t),(null===(n=$.elseBody)||void 0===n?void 0:n.length)&&this.evalBlock({name:t.moduleName,type:"trycatch",body:$.elseBody},t)}catch(h){var ee=h instanceof f?h.name:typeof h,te=h instanceof f?h.message:null!==(r=null==h?void 0:h.message)&&void 0!==r?r:String(h),ne=h instanceof f?h.module:0,re=h instanceof f?h.line:0,oe=h instanceof f?h.column:0,ie=$.exepts[0],se=ie.body,ae=t;ae.blockScope.set((null===(o=ie.error)||void 0===o?void 0:o.alias)||"error",{name:ee,message:te,line:re,column:oe,moduleName:ne}),this.evalBlock({name:t.moduleName,type:"trycatch",body:se},ae),ae.blockScope.set((null===(i=ie.error)||void 0===i?void 0:i.alias)||"error",null)}finally{(null===(a=$.finallyBody)||void 0===a?void 0:a.length)&&this.evalBlock({name:t.moduleName,type:"trycatch",body:$.finallyBody},t)}}}else{var le=e;this.evalNode(le.conditionNode,t)?this.evalBlock({name:t.moduleName,type:"if",body:le.ifBody},t):le.elseBody&&this.evalBlock({name:t.moduleName,type:"if",body:le.elseBody},t)}},e}(),te=function(){function e(){this.moduleParser=function(){return Promise.reject("Module parser is not registered!")},this.jsonFileLoader=function(){return Promise.reject("{}")}}return e.prototype.registerModuleParser=function(e){return this.moduleParser=e,this},e.prototype.registerJsonFileLoader=function(e){return this.jsonFileLoader=e,this},e.prototype.registerBlockContextFactory=function(e){return this.blockContextFactory=e,this},e.prototype.evalBlockAsync=function(e,t){var n,r;return o(this,void 0,void 0,(function(){var l,c,u,p,d,y,v,m,g,k,b,w,N,C,x,A,E,S,O=this;return i(this,(function(j){switch(j.label){case 0:for(l=null,c=function(e){var n=e,r=t.blockScope,a=n.isAsync?function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return o(O,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,this.jspyFuncInvokerAsync.apply(this,s([n,t],e))];case 1:return[2,r.sent()]}}))}))}:function(){for(var e,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return(e=new ee).jspyFuncInvoker.apply(e,s([n,t],r))};r.set(n.funcAst.name,a)},u=0,p=(null==e?void 0:e.funcs)||[];u<p.length;u++)v=p[u],c(v);d=0,y=e.body,j.label=1;case 1:return d<y.length?"comment"===(v=y[d]).type?[3,10]:"import"!==v.type?[3,7]:"json"!==(g=a((m=v).module.name))?[3,3]:(w=(b=JSON).parse,[4,this.jsonFileLoader(m.module.name)]):[3,11];case 2:return k=w.apply(b,[j.sent()]),t.blockScope.set(m.module.alias||this.defaultModuleName(m.module.name),k),[3,10];case 3:if("jspyModule"!==g)return[3,10];j.label=4;case 4:if("function"!=typeof this.blockContextFactory)throw new Error("blockContextFactory is not initialized");return[4,this.moduleParser(m.module.name)];case 5:return N=j.sent(),C=this.blockContextFactory(m.module.name,N),[4,this.evalBlockAsync(N,C)];case 6:return j.sent(),x=t.blockScope.getScope(),(null===(n=m.parts)||void 0===n?void 0:n.length)||(x={},t.blockScope.set(m.module.alias||this.defaultModuleName(m.module.name),x)),this.assignFunctionsToScope(x,C,N,null===(r=m.parts)||void 0===r?void 0:r.map((function(e){return e.name}))),[3,10];case 7:return j.trys.push([7,9,,10]),[4,this.evalNodeAsync(v,t)];case 8:return l=j.sent(),t.returnCalled?(A=t.returnObject,"func"!=e.type&&"module"!=e.type||(t.returnCalled=!1,t.returnObject=null),[2,A]):t.continueCalled||t.breakCalled?[3,11]:[3,10];case 9:throw E=j.sent(),S=v.loc?v.loc:[0,0],E instanceof f||E instanceof h?E:new h(t.moduleName,S[0],S[1],E.message||E);case 10:return d++,[3,1];case 11:return[2,l]}}))}))},e.prototype.assignFunctionsToScope=function(e,t,n,r){for(var a=this,l=n.funcs.filter((function(e){var t;return!r||r.indexOf(null===(t=e.funcAst)||void 0===t?void 0:t.name)>=0})),c=function(n){var r=l[n],c=r.isAsync?function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return o(a,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,this.jspyFuncInvokerAsync.apply(this,s([r,t],e))];case 1:return[2,n.sent()]}}))}))}:function(){for(var e,n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];return(e=new ee).jspyFuncInvoker.apply(e,s([r,t],n))};e[r.funcAst.name]=c},u=0;u<l.length;u++)c(u)},e.prototype.defaultModuleName=function(e){return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))},e.prototype.jspyFuncInvokerAsync=function(e,t){for(var n,r=[],s=2;s<arguments.length;s++)r[s-2]=arguments[s];return o(this,void 0,void 0,(function(){var o,s,a,l;return i(this,(function(i){switch(i.label){case 0:for((o=Object.assign({},e.funcAst)).type="func",s=Z(t),a=0;a<(null===(n=e.params)||void 0===n?void 0:n.length);a++)l=(null==r?void 0:r.length)>a?r[a]:null,s.blockScope.set(e.params[a],l);return[4,this.evalBlockAsync(o,s)];case 1:return[2,i.sent()]}}))}))},e.prototype.invokeFunctionAsync=function(e,t,n){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return 0!==t.length?[3,2]:[4,e()];case 1:return[2,n.sent()];case 2:return 1!==t.length?[3,4]:[4,e(t[0])];case 3:return[2,n.sent()];case 4:return 2!==t.length?[3,6]:[4,e(t[0],t[1])];case 5:return[2,n.sent()];case 6:return 3!==t.length?[3,8]:[4,e(t[0],t[1],t[2])];case 7:return[2,n.sent()];case 8:return 4!==t.length?[3,10]:[4,e(t[0],t[1],t[2],t[3])];case 9:return[2,n.sent()];case 10:return 5!==t.length?[3,12]:[4,e(t[0],t[1],t[2],t[3],t[4])];case 11:return[2,n.sent()];case 12:return 6!==t.length?[3,14]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5])];case 13:return[2,n.sent()];case 14:return 7!==t.length?[3,16]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])];case 15:return[2,n.sent()];case 16:return 8!==t.length?[3,18]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7])];case 17:return[2,n.sent()];case 18:return 9!==t.length?[3,20]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])];case 19:return[2,n.sent()];case 20:return 10!==t.length?[3,22]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9])];case 21:return[2,n.sent()];case 22:return 11!==t.length?[3,24]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10])];case 23:return[2,n.sent()];case 24:return 12!==t.length?[3,26]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11])];case 25:return[2,n.sent()];case 26:return 13!==t.length?[3,28]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12])];case 27:return[2,n.sent()];case 28:return 14!==t.length?[3,30]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13])];case 29:return[2,n.sent()];case 30:return 15!==t.length?[3,32]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14])];case 31:return[2,n.sent()];case 32:throw Error("Function has too many parameters. Current limitation is 15")}}))}))},e.prototype.evalNodeAsync=function(e,t){var n,r,a,l,c;return o(this,void 0,void 0,(function(){var o,u,h,p,d,v,m,g,k,b,w,N,C,x,A,E,S,O,j,_,L,B,T,P,F,I,W,M,V,J,U,D,z,K,R,q,H,Q,X,Y,Z,$,te,ne,re,oe,ie,se,ae,le,ce,ue,he,fe,pe,de,ye,ve,me,ge,ke,be,we,Ne,Ce,xe,Ae,Ee,Se,Oe,je,_e,Le;return i(this,(function(i){switch(i.label){case 0:if("import"===e.type)throw new Error("Import should be defined at the start");return"comment"===e.type?[2,null]:"if"!==e.type?[3,6]:(o=e,[4,this.evalNodeAsync(o.conditionNode,t)]);case 1:return i.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:o.ifBody},t)]:[3,3];case 2:return i.sent(),[3,5];case 3:return o.elseBody?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:o.elseBody},t)]:[3,5];case 4:i.sent(),i.label=5;case 5:return[2];case 6:if("raise"===e.type)throw u=e,new f(t.moduleName,u.loc[0],u.loc[1],u.errorName,u.errorMessage||"");if("tryExcept"!==e.type)return[3,17];h=e,i.label=7;case 7:return i.trys.push([7,11,13,16]),[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:h.tryBody},t)];case 8:return i.sent(),(null===(n=h.elseBody)||void 0===n?void 0:n.length)?[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:h.elseBody},t)]:[3,10];case 9:i.sent(),i.label=10;case 10:return[3,16];case 11:return p=i.sent(),d=p instanceof f?p.name:typeof p,v=p instanceof f?p.message:null!==(r=null==p?void 0:p.message)&&void 0!==r?r:String(p),m=p instanceof f?p.module:0,g=p instanceof f?p.line:0,k=p instanceof f?p.column:0,b=h.exepts[0],w=b.body,(N=t).blockScope.set((null===(a=b.error)||void 0===a?void 0:a.alias)||"error",{name:d,message:v,line:g,column:k,moduleName:m}),[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:w},N)];case 12:return i.sent(),N.blockScope.set((null===(l=b.error)||void 0===l?void 0:l.alias)||"error",null),[3,16];case 13:return(null===(c=h.finallyBody)||void 0===c?void 0:c.length)?[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:h.finallyBody},t)]:[3,15];case 14:i.sent(),i.label=15;case 15:return[7];case 16:return[2];case 17:return"return"!==e.type?[3,21]:(C=e,t.returnCalled=!0,x=t,C.returnValue?[4,this.evalNodeAsync(C.returnValue,t)]:[3,19]);case 18:return A=i.sent(),[3,20];case 19:A=null,i.label=20;case 20:return x.returnObject=A,[2,t.returnObject];case 21:return"continue"===e.type?(t.continueCalled=!0,[2]):"break"===e.type?(t.breakCalled=!0,[2]):"for"!==e.type?[3,27]:(E=e,[4,this.evalNodeAsync(E.sourceArray,t)]);case 22:S=i.sent(),ce=0,i.label=23;case 23:return ce<S.length?(je=S[ce],t.blockScope.set(E.itemVarName,je),[4,this.evalBlockAsync({name:t.moduleName,type:"for",body:E.body},t)]):[3,26];case 24:if(i.sent(),t.continueCalled&&(t.continueCalled=!1),t.breakCalled)return[3,26];i.label=25;case 25:return ce++,[3,23];case 26:return t.breakCalled&&(t.breakCalled=!1),[2];case 27:if("while"!==e.type)return[3,32];O=e,i.label=28;case 28:return[4,this.evalNodeAsync(O.condition,t)];case 29:return i.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"while",body:O.body},t)]:[3,31];case 30:return i.sent(),t.continueCalled&&(t.continueCalled=!1),t.breakCalled?[3,31]:[3,28];case 31:return t.breakCalled&&(t.breakCalled=!1),[2];case 32:if("const"===e.type)return[2,e.value];if("getSingleVar"===e.type){if(j=e.name,void 0===(_=t.blockScope.get(j)))throw";"===j.charAt(j.length-1)?new Error("Unexpected ';' in the end."):new Error("Variable '"+j+"' is not defined.");return[2,_]}return"binOp"!==e.type?[3,35]:(L=e,[4,this.evalNodeAsync(L.left,t)]);case 33:return B=i.sent(),[4,this.evalNodeAsync(L.right,t)];case 34:return T=i.sent(),[2,y[L.op](B,T)];case 35:if("logicalOp"!==e.type)return[3,39];P=e,F=0,I=!0,i.label=36;case 36:return F<P.items.length?(W=P.items[F++],[4,this.evalNodeAsync(W.node,t)]):[3,38];case 37:return I=i.sent(),"and"!==W.op||I?"or"===W.op&&I?[2,I]:[3,36]:[2,!1];case 38:return[2,I];case 39:if("arrowFuncDef"===e.type)return M=e,[2,function(){for(var e,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return(e=new ee).jspyFuncInvoker.apply(e,s([M,t],n))}];if("funcCall"!==e.type)return[3,45];if(pe=e,"function"!=typeof(de=t.blockScope.get(pe.name)))throw Error("'"+pe.name+"' is not a function or not defined.");ye=[],V=0,J=pe.paramNodes||[],i.label=40;case 40:return V<J.length?(Ce=J[V],D=(U=ye).push,[4,this.evalNodeAsync(Ce,t)]):[3,43];case 41:D.apply(U,[i.sent()]),i.label=42;case 42:return V++,[3,40];case 43:return[4,this.invokeFunctionAsync(de,ye,{moduleName:t.moduleName,line:pe.loc[0],column:pe.loc[0]})];case 44:return[2,i.sent()];case 45:return"assign"!==e.type?[3,55]:"getSingleVar"!==(z=e).target.type?[3,47]:(K=z.target,q=(R=t.blockScope).set,H=[K.name],[4,this.evalNodeAsync(z.source,t)]);case 46:return q.apply(R,H.concat([i.sent()])),[3,54];case 47:return"dotObjectAccess"!==z.target.type?[3,50]:($=z.target,Q=new G($.nestedProps.slice(0,$.nestedProps.length-1),$.loc),[4,this.evalNodeAsync(Q,t)]);case 48:return ne=i.sent(),X=$.nestedProps[$.nestedProps.length-1].name,Y=ne,Z=X,[4,this.evalNodeAsync(z.source,t)];case 49:return Y[Z]=i.sent(),[3,54];case 50:return"bracketObjectAccess"!==z.target.type?[3,53]:($=z.target,[4,this.evalNodeAsync($.bracketBody,t)]);case 51:return te=i.sent(),ne=t.blockScope.get($.propertyName),re=ne,oe=te,[4,this.evalNodeAsync(z.source,t)];case 52:return re[oe]=i.sent(),[3,54];case 53:throw Error("Not implemented Assign operation");case 54:return[2,null];case 55:return"bracketObjectAccess"!==e.type?[3,57]:(ie=e,[4,this.evalNodeAsync(ie.bracketBody,t)]);case 56:return se=i.sent(),[2,void 0===(be=t.blockScope.get(ie.propertyName))[se]?null:be[se]];case 57:return"dotObjectAccess"!==e.type?[3,71]:(ae=e,[4,this.evalNodeAsync(ae.nestedProps[0],t)]);case 58:le=i.sent(),ce=1,i.label=59;case 59:return ce<ae.nestedProps.length?(ue=ae.nestedProps[ce],ae.nestedProps[ce-1].nullCoelsing&&!le&&(le={}),"getSingleVar"!==ue.type?[3,60]:(le=le[ue.name],[3,69])):[3,70];case 60:return"bracketObjectAccess"!==ue.type?[3,62]:(le=le[(he=ue).propertyName],fe=le,[4,this.evalNodeAsync(he.bracketBody,t)]);case 61:return le=fe[i.sent()],[3,69];case 62:if("funcCall"!==ue.type)return[3,68];if(null==(de=le[(pe=ue).name])&&ae.nestedProps[ce-1].nullCoelsing)return le=null,[3,69];if("function"!=typeof de)throw Error("'"+pe.name+"' is not a function or not defined.");ye=[],ve=0,me=pe.paramNodes||[],i.label=63;case 63:return ve<me.length?(Ce=me[ve],ke=(ge=ye).push,[4,this.evalNodeAsync(Ce,t)]):[3,66];case 64:ke.apply(ge,[i.sent()]),i.label=65;case 65:return ve++,[3,63];case 66:return[4,this.invokeFunctionAsync(de.bind(le),ye,{moduleName:t.moduleName,line:pe.loc[0],column:pe.loc[0]})];case 67:return le=i.sent(),[3,69];case 68:throw Error("Can't resolve dotObjectAccess node");case 69:return ce++,[3,59];case 70:return[2,void 0===le?null:le];case 71:if("createObject"!==e.type)return[3,77];be={},we=0,Ne=e.props,i.label=72;case 72:return we<Ne.length?(Ce=Ne[we],xe=be,[4,this.evalNodeAsync(Ce.name,t)]):[3,76];case 73:return Ae=i.sent(),[4,this.evalNodeAsync(Ce.value,t)];case 74:xe[Ae]=i.sent(),i.label=75;case 75:return we++,[3,72];case 76:return[2,be];case 77:if("createArray"!==e.type)return[3,82];Ee=[],Se=0,Oe=e.items,i.label=78;case 78:return Se<Oe.length?(je=Oe[Se],Le=(_e=Ee).push,[4,this.evalNodeAsync(je,t)]):[3,81];case 79:Le.apply(_e,[i.sent()]),i.label=80;case 80:return Se++,[3,78];case 81:return[2,Ee];case 82:return[2]}}))}))},e}(),ne={jsPython:function(){return["JSPython v2.1.7","(c) 2021 FalconSoft Ltd. All rights reserved."].join("\n")},dateTime:function(e){return void 0===e&&(e=null),function(e){if(!e)return null;if(e instanceof Date&&!isNaN(e.valueOf()))return e;if("string"!=typeof e)return null;var t=String(e);if(!t.length)return null;var n=function(e){if(!e||!e.length)return NaN;var t=parseInt(e,10);return isNaN(t)?e.startsWith("jan")?0:e.startsWith("feb")?1:e.startsWith("mar")?2:e.startsWith("apr")?3:e.startsWith("may")?4:e.startsWith("jun")?5:e.startsWith("jul")?6:e.startsWith("aug")?7:e.startsWith("sep")?8:e.startsWith("oct")?9:e.startsWith("nov")?10:e.startsWith("dec")?11:NaN:t-1},r=function(e){return e<100?e<68?e+2e3:e+1900:e},o=function(e,t,n,r,o,i){if(t>11||n>31||r>=60||o>=60||i>=60)return null;var s=new Date(e,t,n,r,o,i,0);return isNaN(s.valueOf())?null:s},i=t.replace("T"," ").toLowerCase().split(/[: /-]/),s=i.map(parseFloat),a=o(s[0],s[1]-1,s[2],s[3]||0,s[4]||0,s[5]||0);return a||((a=o(r(s[2]),n(i[1]),s[0],s[3]||0,s[4]||0,s[5]||0))?a:(a=o(r(s[2]),n(i[0]),r(s[1]),s[3]||0,s[4]||0,s[5]||0))||null)}(e)||new Date},range:function(e,t,n){void 0===t&&(t=NaN);void 0===n&&(n=1);var r=[],o=isNaN(t);t=o?e:t;var i=e=o?0:e;for(;i<t;)r.push(i),i+=n;return r},print:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return console.log.apply(console,e),e.length>0?e[0]:null},isNull:function(e,t){return void 0===t&&(t=null),null===t?null===e:e||t},isDate:function(e){return e instanceof Date},isFunction:function(e){return"function"==typeof e},isString:function(e){return"string"==typeof e},deleteProperty:function(e,t){return delete e[t]},Math:Math,Object:Object,Array:Array,JSON:JSON,printExecutionContext:function(){},getExecutionContext:function(){}};var re=function(){function e(){this.tokens=[]}return e.prototype.startLine=function(){return N(this.tokens[0])},e.prototype.startColumn=function(){return C(this.tokens[0])},e.prototype.endLine=function(){return this.tokens[this.tokens.length-1][1][3]},e.prototype.endColumn=function(){return this.tokens[this.tokens.length-1][1][4]},e}(),oe=function(){function e(){this._currentToken=null,this._moduleName=""}return e.prototype.parse=function(e,t,n){var r;void 0===t&&(t="main.jspy"),void 0===n&&(n="module"),this._moduleName=t;var o={name:t,type:n,funcs:[],body:[]};if(!e||!e.length)return o;try{var i=this.tokensToInstructionLines(e,1);this.instructionsToNodes(i,o)}catch(e){var s=null!==(r=this._currentToken)&&void 0!==r?r:{};throw new u(o.name,N(s),C(s),e.message||e)}return o},e.prototype.instructionsToNodes=function(e,t){for(var n=this,r=function(e,r){var o=n.tokensToInstructionLines(e,N(e[r])),i={name:t.name,body:[],funcs:[]};return n.instructionsToNodes(o,i),i.body},o=function(e,t,n){return n.splice(0,n.length),S(e,t).forEach((function(e){return n.push(e)})),!!n.length},i=0;i<e.length;i++){for(var s=e[i],a=0;a<s.tokens.length;)k(s.tokens[a])===p.Comment?s.tokens.splice(a,1):a++;if(s.tokens.length){var l=s.tokens[0],u=s.tokens.length>1?s.tokens[1]:null;this._currentToken=l;var h=[];if(k(l)===p.Comment)t.body.push(new B(b(l),w(l)));else if("def"===b(l)||"async"===b(l)&&"def"===b(u)){var f="async"===b(l),d=b(s.tokens[f?2:1]),y=x(s.tokens.slice(s.tokens.findIndex((function(e){return"("===b(e)}))+1,s.tokens.findIndex((function(e){return")"===b(e)}))),",").map((function(e){return b(e[0])}));if(-1===(X=A(s.tokens,(function(e){return":"===e}))))throw"Can't find : for def";var v=this.tokensToInstructionLines(s.tokens,N(s.tokens[X+1])),m={name:d,body:[],funcs:[]};this.instructionsToNodes(v,m),t.funcs.push(new M(m,y,f,w(s.tokens[0])))}else if("if"===b(l)){if(-1===(X=A(s.tokens,(function(e){return":"===e}))))throw"Can't find : for if";var g=r(s.tokens,X+1),C=o(Y=s.tokens.slice(1,X),c.Logical,h)?this.groupLogicalOperations(h,Y):this.createExpressionNode(Y),E=void 0;e.length>i+1&&"else"===b(e[i+1].tokens[0])&&":"===b(e[i+1].tokens[1])&&(E=r(e[i+1].tokens,2),i++),t.body.push(new J(C,g,E,w(l)))}else if("try"===b(l)){if(":"!==b(s.tokens[1]))throw"'try' statement should be followed by ':'";for(var O=r(s.tokens,2),j=[],L=(E=void 0,void 0);e.length>i+1&&("else"===b(e[i+1].tokens[0])||"except"===b(e[i+1].tokens[0])||"finally"===b(e[i+1].tokens[0]));){if("else"===b(e[i+1].tokens[0])){if(E)throw new Error("Only one 'else' is allowed in a 'try'");E=r(e[i+1].tokens,2)}if("finally"===b(e[i+1].tokens[0])){if(L)throw new Error("Only one 'else' is allowed in a 'try'");L=r(e[i+1].tokens,2)}if("except"===b(e[i+1].tokens[0])){var W=A(e[i+1].tokens,(function(e){return":"===e})),V={};if(2===W)V.error={name:b(e[i+1].tokens[1])};else if(3===W)V.error={name:b(e[i+1].tokens[1]),alias:b(e[i+1].tokens[2])};else if(4===W)V.error={name:b(e[i+1].tokens[1]),alias:b(e[i+1].tokens[3])};else if(1!==W)throw new Error("Incorrect 'except:' statement. Valid stats: (except: or except Error: or except Error as e:)");V.body=r(e[i+1].tokens,W+1),j.push(V)}i++}if(!j.length)throw new Error("Except: is missing");t.body.push(new U(O,j,E,L,w(l)))}else if("continue"===b(l))t.body.push(new F);else if("break"===b(l))t.body.push(new I);else if("return"===b(l))t.body.push(new T(s.tokens.length>1?this.createExpressionNode(s.tokens.slice(1)):void 0,w(l)));else if("raise"===b(l)){if(1===s.tokens.length)throw new Error("Incorrect 'raise' usage. Please specify error name and message ");var R=b(s.tokens[1]),G=5==s.tokens.length&&"("===b(s.tokens[2])&&")"===b(s.tokens[4])?b(s.tokens[3]):void 0;t.body.push(new P(R,G,w(l)))}else if("for"===b(l)){if(-1===(X=A(s.tokens,(function(e){return":"===e}))))throw"Can't find : for if";var q=b(s.tokens[1]),H=this.createExpressionNode(s.tokens.slice(3,X)),Q=r(s.tokens,X+1);t.body.push(new D(H,q,Q,w(l)))}else if("while"===b(l)){var X;if(-1===(X=A(s.tokens,(function(e){return":"===e}))))throw"Can't find : for [while]";C=o(Y=s.tokens.slice(1,X),c.Logical,h)?this.groupLogicalOperations(h,Y):this.createExpressionNode(Y);var Y,Z=r(s.tokens,X+1);t.body.push(new z(C,Z,w(l)))}else if("import"===b(l)){var $=A(s.tokens,(function(e){return"as"===e}));$<0&&($=s.tokens.length);var ee={name:s.tokens.slice(1,$).map((function(e){return b(e)})).join(""),alias:s.tokens.slice($+1).map((function(e){return b(e)})).join("")||void 0};Z={};t.body.push(new K(ee,Z,void 0,w(l)))}else if("from"===b(l)){var te=A(s.tokens,(function(e){return"import"===e}));if(te<0)throw Error("'import' must follow 'from'");var ne={name:s.tokens.slice(1,te).map((function(e){return b(e)})).join("")},re=x(s.tokens.slice(te+1),",").map((function(e){return{name:b(e[0]),alias:3===e.length?b(e[2]):void 0}}));Z={};t.body.push(new K(ne,Z,re,w(l)))}else if(o(s.tokens,c.Assignment,[])){var oe=x(s.tokens,"="),ie=this.createExpressionNode(oe[0]),se=this.createExpressionNode(oe[1]);t.body.push(new _(ie,se,w(oe[0][0])))}else o(s.tokens,c.Logical,h)?t.body.push(this.groupLogicalOperations(h,s.tokens)):t.body.push(this.createExpressionNode(s.tokens))}}},e.prototype.sliceWithBrackets=function(e,t,n){return"("===b(e[t])&&k(e[t])!==p.LiteralString&&(t++,n--),e.slice(t,n)},e.prototype.groupComparisonOperations=function(e,t){for(var n=null,r=0;r<e.length;r++){var o=b(t[e[r]]);n=n||this.createExpressionNode(this.sliceWithBrackets(t,0,e[r]));var i=r+1<e.length?e[r+1]:t.length,s=this.createExpressionNode(this.sliceWithBrackets(t,e[r]+1,i));n=new Y(n,o,s,w(t[0]))}return n},e.prototype.groupLogicalOperations=function(e,t){for(var n=0,r=[],o=0;o<e.length;o++){var i=t[e[o]],s=this.sliceWithBrackets(t,n,e[o]);r.push({node:this.createExpressionNode(s),op:b(i)}),n=e[o]+1}return r.push({node:this.createExpressionNode(this.sliceWithBrackets(t,n,t.length))}),new X(r,w(t[0]))},e.prototype.tokensToInstructionLines=function(e,t){for(var n=[],r=0,o=new re,i=0;i<e.length;i++){var s=e[i],a=N(s),l=C(s),c=b(s);if(this._currentToken=s,a>=t&&(r!==l||")}]".includes(c)||(n.push(o),o=new re),o.tokens.push(s),0===r&&(r=l),l<r))break}return o.tokens.length&&n.push(o),n},e.prototype.createExpressionNode=function(e,t){var n=this;if(0===e.length)throw new Error("Tokens length can't empty.");var r=e[e.length-1];if(";"===b(r)&&k(r)!==p.LiteralString)throw new Error("Unexpected symbol ';' in the end");if(this._currentToken=e[0],1===e.length||2===e.length&&"?"===b(e[1])){var o=e[0],i=k(o);if(function(e){return e===p.LiteralString||e===p.LiteralNumber||e===p.LiteralBool||e===p.LiteralNull}(i))return new L(o);if(i===p.Identifier)return new R(o,2===e.length&&"?"===b(e[1])||void 0);throw Error("Unhandled single token: '"+JSON.stringify(o)+"'")}var s=x(e,"=>");if(s.length>1){var a=x("("===b(s[0][0])?s[0].splice(1,s[0].length-2):s[0],",").map((function(e){return b(e[0])})),l=this.tokensToInstructionLines(s[1],0),u={name:this._moduleName,body:[],funcs:[]};return this.instructionsToNodes(l,u),new V(u,a,w(e[0]))}var h=S(e,c.Comparison);if(h.length)return this.groupComparisonOperations(h,e);var f=S(e);if(f.length){for(var d=null,y=0;y<f.length;y++){var v=f[y],m=b(e[v]),g=y+1<f.length?f[y+1]:null,N=null!==g?b(e[g]):null;if(null===g||"*"!==N&&"/"!==N){F=d?[]:this.sliceWithBrackets(e,0,v);var C=this.sliceWithBrackets(e,v+1,g||e.length),A=d||this.createExpressionNode(F,d),E=this.createExpressionNode(C);d=new Y(A,m,E,w(e[0]))}else{var O=null;do{var j=y+2<f.length?f[y+2]:null,_=this.sliceWithBrackets(e,v+1,g),B=this.sliceWithBrackets(e,g+1,j||e.length),T=this.createExpressionNode(_),P=this.createExpressionNode(B);O=new Y(T,N,P,w(e[v+1])),N=null!==(g=++y+1<f.length?f[y+1]:null)?b(e[g]):null}while(null!==g&&("*"===N||"/"===N));if(null===d){var F=this.sliceWithBrackets(e,0,v);d=this.createExpressionNode(F)}d=new Y(d,m,O,w(e[0]))}}if(null===d)throw Error("Can't create node ...");return d}var I=x(e,".");if(I.length>1)return new G(I.map((function(e){return n.createExpressionNode(e)})),w(e[0]));if(e.length>2&&"("===b(e[1])){var M="?"===b(e[e.length-1]);M&&e.pop();var J=b(e[0]),U=x(re=e.slice(2,e.length-1),",").map((function(e){return n.createExpressionNode(e)})),D=new W(J,U,w(e[0]));return D.nullCoelsing=M||void 0,D}if("{"===b(e[0])&&"}"===b(e[e.length-1])){var z=x(e.splice(1,e.length-2),","),K=[];for(y=0;y<z.length;y++){var X=x(z[y],":");if(1===X.length){var Z={name:new L(X[0][0]),value:this.createExpressionNode(X[0])};K.push(Z)}else{if(2!==X.length)throw Error("Incorrect JSON");var $=null,ee=X[0];if(1===ee.length)$=new L(ee[0]);else{if("["!==b(ee[0])||"]"!==b(ee[ee.length-1]))throw new Error("Incorrect JSON. Can't resolve Key field. That should either constant or expression in []");$=this.createExpressionNode(ee.slice(1,ee.length-1))}Z={name:$,value:this.createExpressionNode(X[1])};K.push(Z)}}return new q(K,w(e[0]))}if("["===b(e[0])&&"]"===b(e[e.length-1])){var te=x(e.splice(1,e.length-2),",").map((function(e){return n.createExpressionNode(e)}));return new H(te,w(e[0]))}if(e.length>2&&"["===b(e[1])){var ne=b(e[0]),re=e.slice(2,e.length-1);U=this.createExpressionNode(re);return new Q(ne,U,!1,w(e[0]))}throw Error("Undefined node '"+b(e[0])+"'.")},e}(),ie={"\n":["\n"],"=":["=","==","=>"],"+":["+","++","+="],"-":["-","--","-="],"*":["*","**","*="],"/":["/","//","/="],".":["."],"?":["?"],"!":["!="],":":[":"],",":[","],">":[">",">="],"<":["<","<=","<>"],"(":["("],")":[")"],"{":["{"],"}":["}"],"[":["["],"]":["]"]},se=["async","def","for","while","if","return","in"],ae=function(){function e(){this._startLine=1,this._startColumn=1,this._currentLine=1,this._currentColumn=1,this._tokenText="",this._cursor=0,this._script=""}return Object.defineProperty(e.prototype,"tokenText",{get:function(){return this._tokenText},set:function(e){!this._tokenText&&e&&(this._startLine=this._currentLine,this._startColumn=this._currentColumn),this._tokenText=e},enumerable:!1,configurable:!0}),e.prototype.tokenize=function(e){if(!e||!e.length)return[];e=e.replace(new RegExp("\t","g"),"  ").replace(new RegExp("\r","g"),""),this._script=e,this._cursor=0,this._startLine=1,this._startColumn=1,this._currentLine=1,this._currentColumn=1;for(var t=[],n=!0;"\n"===e[this._cursor];)this.incrementCursor(),n&&(this._currentLine++,n=!1),this._currentColumn=1;do{var r=e[this._cursor];if(" "!=r||0===this.tokenText.length)if(void 0===ie[r]||this.isPartOfNumber(r,t))if("#"===r){for(var o=!0;"\n"!==e[this.incrementCursor()]&&(this.tokenText+=e[this._cursor],o&&(o=!1,this._startColumn=this._startColumn-1),!(this._cursor+1>=e.length)););this.tokenText=this.processToken(this.tokenText,t,!0,p.Comment)}else if('"'===r||"'"===r){var i=r;if(this.tokenText=this.processToken(this.tokenText,t),e[this._cursor+1]===i&&e[this._cursor+2]===i){var s=this._currentLine,a=this._currentColumn;this.incrementCursor(2);for(;this.tokenText+=e[this.incrementCursor()],!(this._cursor+3>=e.length||e[this._cursor+1]===i&&e[this._cursor+2]===i&&e[this._cursor+3]===i););this._startLine=s,this._startColumn=a,this.incrementCursor(3)}else{for(;e[this.incrementCursor()]!==i&&(this.tokenText+=e[this._cursor],!(this._cursor+1>=e.length)););this._startColumn--}0===this.tokenText.length&&(this._startLine=this._currentLine,this._startColumn=this._currentColumn),this.tokenText=this.processToken(this.tokenText,t,!0,p.LiteralString)}else" "!=r&&(this.tokenText+=r);else{this.tokenText=this.processToken(this.tokenText,t),this.tokenText=r;var l=ie[r];if(l.length>=1)for(;l.includes(this.tokenText+e[this._cursor+1]);)this.tokenText+=e[this.incrementCursor()];this.tokenText=this.processToken(this.tokenText,t,!1,p.Operator)}else this.tokenText=this.processToken(this.tokenText,t)}while(this.incrementCursor()<e.length);return this.processToken(this.tokenText,t),t},e.prototype.incrementCursor=function(e){void 0===e&&(e=1);for(var t=0;t<e;t++)this._cursor=this._cursor+1,"\n"===this._script[this._cursor]?(this._currentLine++,this._currentColumn=0):this._currentColumn++;return this._cursor},e.prototype.recognizeToken=function(e,t){void 0===t&&(t=null);var n=e;return null===t&&("null"===e?(t=p.LiteralNull,n=null):"true"===e||"false"===e?(t=p.LiteralBool,n="true"===e):null!==this.parseNumberOrNull(e)?(t=p.LiteralNumber,n=this.parseNumberOrNull(e)):t=se.indexOf(e)>=0?p.Keyword:p.Identifier),{value:n,type:t}},e.prototype.processToken=function(e,t,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=null),!e.length&&!n||"\n"===e)return"";var o=this.recognizeToken(e,r);return t.push([o.value,Uint16Array.of(o.type,this._startLine,this._startColumn,this._currentLine,this._currentColumn)]),""},e.prototype.parseNumberOrNull=function(e){if("number"==typeof e)return e;if(!e||"string"!=typeof e)return null;for(var t=(e=e.trim()).length-1;t>=0;t--){var n=e.charCodeAt(t);if((n<48||n>57)&&46!==n&&44!==n&&(45!==n||0!==t))return null}var r=parseFloat(e);return isNaN(r)?null:r},e.prototype.isPartOfNumber=function(e,t){if("-"===e&&!this.tokenText.length){var n=0!==t.length?t[t.length-1]:null;return null===n||k(n)===p.Operator&&")"!==b(n)}return"."===e&&null!==this.parseNumberOrNull(this.tokenText)},e}();var le=function(){function e(){this.initialScope=r({},ne),this._lastExecutionContext=null}return e.create=function(){return new e},Object.defineProperty(e.prototype,"initialExecutionContext",{get:function(){return this.initialScope},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastExecutionContext",{get:function(){return this._lastExecutionContext},enumerable:!1,configurable:!0}),e.prototype.cleanUp=function(){this._lastExecutionContext=null},e.prototype.jsPythonInfo=function(){return ne.jsPython()},e.prototype.tokenize=function(e){return(new ae).tokenize(e)},e.prototype.parse=function(e,t){void 0===t&&(t="main.jspy");var n=new ae;return(new oe).parse(n.tokenize(e),t)},e.prototype.eval=function(e,t,n,r){void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy");var o="string"==typeof e?this.parse(e,r):e,i={moduleName:r,blockScope:new $(t)};i.blockScope.set("printExecutionContext",(function(){return console.log(i.blockScope.getScope())})),i.blockScope.set("getExecutionContext",(function(){return i.blockScope.getScope()})),this._lastExecutionContext=i.blockScope.getScope();var s=(new ee).evalBlock(o,i);if(n&&n.length){var a=i.blockScope.get(n);if("function"!=typeof a)throw Error("Function "+n+" does not exists or not a function");return a()}return s},e.prototype.evalAsync=function(e,t,n,r){return void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy"),o(this,void 0,void 0,(function(){var s,a,l,c,u,h=this;return i(this,(function(f){switch(f.label){case 0:return s="string"==typeof e?this.parse(e,r):e,a=new te,(l={moduleName:r,blockScope:new $(t)}).blockScope.set("printExecutionContext",(function(){return console.log(l.blockScope.getScope())})),l.blockScope.set("getExecutionContext",(function(){return l.blockScope.getScope()})),this._lastExecutionContext=l.blockScope.getScope(),[4,a.registerJsonFileLoader((function(e){return o(h,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.moduleLoader?this.moduleLoader(e):Promise.reject("ModuleLoader is not registered")];case 1:return[2,t.sent()]}}))}))})).registerModuleParser((function(e){return o(h,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.moduleParser(e)];case 1:return[2,t.sent()]}}))}))})).registerBlockContextFactory((function(e,n){var r=h.assignImportContext(n,t),o={moduleName:e,blockScope:new $(r)};return o.blockScope.set("printExecutionContext",(function(){return console.log(o.blockScope.getScope())})),o.blockScope.set("getExecutionContext",(function(){return o.blockScope.getScope()})),o})).evalBlockAsync(s,l)];case 1:return c=f.sent(),n&&n.length?[3,2]:[2,c];case 2:if("function"!=typeof(u=l.blockScope.get(n)))throw Error("Function "+n+" does not exists or not a function");return[4,u()];case 3:return[2,f.sent()]}}))}))},e.prototype.evaluate=function(e,t,n,s){return void 0===t&&(t={}),void 0===n&&(n=""),void 0===s&&(s="main.jspy"),o(this,void 0,void 0,(function(){var o,a;return i(this,(function(i){switch(i.label){case 0:return e&&e.length?(o=this.parse(e,s),t=t&&"object"==typeof t?t:{},t=this.assignImportContext(o,t),a=r(r({},this.initialScope),t),[4,this.evalAsync(o,a,n,s)]):[2,null];case 1:return[2,i.sent()]}}))}))},e.prototype.registerPackagesLoader=function(e){if("function"!=typeof e)throw Error("PackagesLoader");return this.packageLoader=e,this},e.prototype.registerModuleLoader=function(e){if("function"!=typeof e)throw Error("ModuleLoader should be a function");return this.moduleLoader=e,this},e.prototype.addFunction=function(e,t){return this.initialScope[e]=t,this},e.prototype.assignGlobalContext=function(e){return Object.assign(this.initialScope,e),this},e.prototype.hasFunction=function(e,t){return void 0===e&&(e=""),e.indexOf("def "+t)>-1},e.prototype.assignImportContext=function(e,t){var n=e.body.filter((function(e){return"import"===e.type})).filter((function(e){return"jsPackage"===a(e.module.name)})).map((function(e){return function(e){var t;return{name:e.module.name,as:e.module.alias,properties:null===(t=e.parts)||void 0===t?void 0:t.map((function(e){return{name:e.name,as:e.alias}}))}}(e)}));if(n.length&&this.packageLoader){var o=this.packageResolver(n);t=r(r({},t),o)}return t},e.prototype.moduleParser=function(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:if(!this.moduleLoader)throw new Error("Module Loader is not registered");return[4,this.moduleLoader(e)];case 1:return t=n.sent(),[2,this.parse(t,e)]}}))}))},e.prototype.packageResolver=function(e){var t=this;if(!this.packageLoader)throw Error("Package loader not provided.");var n={};return e.forEach((function(e){var r=e.name,o=e.as,i=e.properties,s=t.packageLoader&&t.packageLoader(r);(null==i?void 0:i.length)?i.forEach((function(e){n[e.as||e.name]=s[e.name]})):o?n[o]=s:n[r]=s,o&&(n[o]=s)})),n},e}();e.Interpreter=le,e.jsPython=function(){return le.create()},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=jspython-interpreter.min.js.map
